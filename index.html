<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload & Run Python on Phone Server</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; padding: 18px; max-width: 720px; margin: auto; }
    label{display:block; margin-top:10px;}
    input[type="text"], input[type="file"]{width:100%;}
    button{margin-top:12px; padding:8px 12px;}
    pre { background:#f3f3f3; padding:10px; overflow:auto; max-height:260px; }
    .status {margin-top:10px; font-size:0.95rem;}
  </style>
</head>
<body>
  <h2>Upload & Run (.py) â€” Phone Server</h2>

  <!-- ====== CONFIG: Set your server URL here ====== -->
  <script>
    // Set this to your phone server address (include http:// or https:// and port if any)
    const SERVER_URL = "http://192.168.1.5:8000"; // <-- change this to your server IP:port
  </script>
  <!-- ============================================== -->

  <form id="uploadForm">
    <label>Server URL:
      <input type="text" id="serverUrlInput" value="" placeholder="Optional: change before upload">
    </label>

    <label>Upload token (same as UPLOAD_TOKEN on server):
      <input type="text" id="token" value="" placeholder="Enter your upload token">
    </label>

    <label>Choose .py file:
      <input type="file" id="fileInput" accept=".py" required>
    </label>

    <button type="submit">Upload & Run</button>
  </form>

  <div class="status" id="status"></div>
  <h3>Debug / Response</h3>
  <pre id="log"></pre>

  <script>
    (function(){
      // initialize server url input with default
      const defaultServer = typeof SERVER_URL !== "undefined" ? SERVER_URL : "";
      const serverUrlInput = document.getElementById('serverUrlInput');
      serverUrlInput.value = defaultServer;

      const statusEl = document.getElementById('status');
      const logEl = document.getElementById('log');

      function log(msg){
        logEl.textContent += msg + "\n";
      }

      async function uploadAndRun(serverUrl, file, token){
        statusEl.textContent = "Uploading file to " + serverUrl + "/upload ...";
        log("Uploading file: " + (file ? file.name : "(no file)"));

        const form = new FormData();
        form.append('file', file);
        form.append('token', token || "");

        // send upload
        let uploadResponse;
        try {
          uploadResponse = await fetch(serverUrl + "/upload", {
            method: 'POST',
            body: form,
            redirect: 'follow' // follow redirect to index
          });
        } catch (err) {
          statusEl.textContent = "Network error during upload: " + err;
          log("Upload error: " + err);
          return;
        }

        log("Upload HTTP status: " + uploadResponse.status + " (" + uploadResponse.statusText + ")");
        statusEl.textContent = "Upload complete. Looking for run link...";

        // Now fetch index page and try to find the newest /run/<name> link.
        let indexText;
        try {
          const idxResp = await fetch(serverUrl + "/");
          indexText = await idxResp.text();
        } catch (err) {
          statusEl.textContent = "Failed to fetch index page: " + err;
          log("Index fetch error: " + err);
          return;
        }

        // Heuristic: find all occurrences of /run/<filename> in the HTML and pick the last one.
        // Matches href="/run/<something>" or /run/<something>"
        const runRegex = /\/run\/([A-Za-z0-9_\-\.%]+)"/g;
        let match;
        let last = null;
        while ((match = runRegex.exec(indexText)) !== null) {
          last = match[1];
        }

        if (!last) {
          // alternative: try to find links like href='/run/<name>' with single quotes
          const runRegex2 = /\/run\/([A-Za-z0-9_\-\.%]+)'/g;
          while ((match = runRegex2.exec(indexText)) !== null) {
            last = match[1];
          }
        }

        if (!last) {
          statusEl.textContent = "Unable to detect run link from server index. Check server index page manually.";
          log("Index HTML excerpt:\n" + indexText.slice(0, 1000));
          return;
        }

        // decode filename if URL-encoded
        const decoded = decodeURIComponent(last);
        const runUrl = serverUrl.replace(/\/$/, "") + "/run/" + encodeURIComponent(last);

        statusEl.innerHTML = `Found run file <b>${decoded}</b>. Opening run URL...`;
        log("Detected run filename: " + decoded);
        log("Opening: " + runUrl);

        // Open run URL in new tab/window to show output
        window.open(runUrl, '_blank');
      }

      document.getElementById('uploadForm').addEventListener('submit', function(e){
        e.preventDefault();
        logEl.textContent = "";
        const fileInput = document.getElementById('fileInput');
        const token = document.getElementById('token').value.trim();
        const serverUrl = (document.getElementById('serverUrlInput').value || defaultServer).trim();

        if (!serverUrl) {
          statusEl.textContent = "Please set SERVER URL (phone IP and port).";
          return;
        }
        if (!fileInput.files || fileInput.files.length === 0) {
          statusEl.textContent = "Please choose a .py file to upload.";
          return;
        }
        if (!token) {
          statusEl.textContent = "Please enter upload token.";
          return;
        }

        uploadAndRun(serverUrl, fileInput.files[0], token);
      });

    })();
  </script>
</body>
</html>
